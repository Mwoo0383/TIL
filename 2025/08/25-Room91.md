# Room91 작업 정리

> 패키지 구조 리팩토링, DTO/응답 래퍼 도입, 뉴스 날짜/정렬, 뉴스 비디오 스트리밍 서비스화, 배포/DB 패치 한 번에 정리

---

## 1) 공통/글로벌

- `global/common/base/BaseEntity` 도입  
  - `@MappedSuperclass`, JPA Auditing(`@CreatedDate`, `@LastModifiedDate`) 적용  
  - 엔티티에서 중복 `@PrePersist/@PreUpdate` 제거
- 전역 응답/예외
  - `global/common/dto/ApiResponse<T>`: `ok(data)`, `error(code, message)` 정적 팩토리
  - `global/common/exception/{ErrorCode,BizException}`  
    - `RESOURCE_NOT_FOUND`, `INVALID_STATE`, `EXTERNAL_API_ERROR` 등 정의
  - (기존 `@RestControllerAdvice`가 있으면 `BizException` 매핑)

---

## 2) 도메인 리팩토링 (House/TwoRoom)

- 컨트롤러에서 **엔티티 직접 반환 금지** → DTO 도입
  - `domain/house/dto/{HouseResponse, TwoRoomResponse}`
  - 서비스에서 조회 → 매퍼로 DTO 변환 → `ApiResponse<List<...>>`로 응답
- 컨트롤러 시그니처 정리
  - 필터 파라미터 병합(`tradeTypes`/`tradeTypeCodes`)
  - `ResponseEntity<ApiResponse<...>>` 일관화

  ---

## 3) 뉴스 목록 API (날짜 포맷 & 최신순)

- DTO 변경: 날짜를 문자열로 고정
  - `domain/news/dto/NewsResponse`  
    ```java
    public record NewsResponse(long id, String createdDate, String newsText) {
      private static final DateTimeFormatter DTF = DateTimeFormatter.ofPattern("yyyy-MM-dd");
      public static NewsResponse from(News n){
        return new NewsResponse(n.getId(),
          n.getCreatedAt()!=null ? n.getCreatedAt().toLocalDate().format(DTF) : null,
          n.getNewsText());
      }
    }
    ```
- 정렬: `NewsRepository#findAllByOrderByCreatedAtDesc()` 사용
- 서비스: `list()`에서 최신순 조회 → `NewsResponse`로 변환

---

## 4) 뉴스 비디오 스트리밍 로직 서비스화

- DTO(레코드) 추가: `domain/news/dto/NewsVideo`
  ```java
  public record NewsVideo(Resource resource, String filename, MediaType contentType, long contentLength) {}

---

## 5) DB 스키마 패치 (운영/로컬 공통)

- 원인: 리팩토링 후 JPA가 created_at/updated_at을 조회 → 기존 테이블에 컬럼 없음

```SQL
ALTER TABLE public.users ADD COLUMN IF NOT EXISTS created_at TIMESTAMP;
ALTER TABLE public.users ADD COLUMN IF NOT EXISTS updated_at TIMESTAMP;
UPDATE public.users SET created_at = COALESCE(created_at, now());
UPDATE public.users SET updated_at = COALESCE(updated_at, created_at);
ALTER TABLE public.users ALTER COLUMN created_at SET NOT NULL;
ALTER TABLE public.users ALTER COLUMN updated_at SET NOT NULL;
ALTER TABLE public.users ALTER COLUMN created_at SET DEFAULT now();
ALTER TABLE public.users ALTER COLUMN updated_at SET DEFAULT now();

ALTER TABLE public.refined_news ADD COLUMN IF NOT EXISTS updated_at TIMESTAMP;
UPDATE public.refined_news SET updated_at = COALESCE(updated_at, created_at, now());
ALTER TABLE public.refined_news ALTER COLUMN updated_at SET NOT NULL;
ALTER TABLE public.refined_news ALTER COLUMN updated_at SET DEFAULT now();
```